<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | MindEase</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/app.css">
</head>
<body>
  <!-- Navigation Sidebar -->
  <nav class="nav-sidebar" id="sidebar">
    <div class="nav-brand">
      <div class="nav-logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
      </div>
      <span class="nav-title">MindEase</span>
    </div>
    <div class="nav-menu">
      <div class="nav-section">
        <div class="nav-section-title">Main</div>
        <a href="dashboard.html" class="nav-link active">
          <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></span>
          <span>Dashboard</span>
        </a>
        <a href="checkin.html" class="nav-link">
          <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></span>
          <span>Check-in</span>
        </a>
        <a href="todo.html" class="nav-link">
          <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></span>
          <span>Tasks</span>
        </a>
        <a href="habits.html" class="nav-link">
          <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span>
          <span>Habits</span>
        </a>
        <a href="focus.html" class="nav-link">
          <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
          <span>Focus</span>
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Wellness</div>
        <a href="journal.html" class="nav-link">
          <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></span>
          <span>Journal</span>
        </a>
        <a href="calendar.html" class="nav-link">
          <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span>
          <span>Calendar</span>
        </a>
        <a href="analytics.html" class="nav-link">
          <span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg></span>
          <span>Analytics</span>
        </a>
      </div>
    </div>
    <div class="nav-footer">
      <a href="profile.html" class="nav-user">
        <div class="nav-avatar" id="userAvatar">U</div>
        <div class="nav-user-info">
          <div class="nav-user-name" id="navUserName">User</div>
          <div class="nav-user-email" id="navUserEmail">email@example.com</div>
        </div>
      </a>
    </div>
  </nav>

  <!-- Mobile Overlay -->
  <div class="nav-overlay" id="navOverlay" onclick="toggleSidebar()"></div>

  <!-- Mobile Header -->
  <header class="mobile-header">
    <button class="menu-toggle" onclick="toggleSidebar()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="12" x2="21" y2="12"/>
        <line x1="3" y1="6" x2="21" y2="6"/>
        <line x1="3" y1="18" x2="21" y2="18"/>
      </svg>
    </button>
    <span class="mobile-title">Dashboard</span>
    <button class="theme-toggle" onclick="toggleTheme()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
    </button>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="flex justify-between items-center" style="flex-wrap:wrap; gap:var(--space-4);">
        <div>
          <h1 id="greeting">Good morning</h1>
          <p id="todayDate"></p>
        </div>
        <div class="header-actions">
          <a href="checkin.html" class="btn">Daily Check-in</a>
        </div>
      </div>
    </div>

    <!-- Insight Card -->
    <div class="insight-card mb-6" id="insightCard">
      <h4>Daily Insight</h4>
      <p id="insightText">Start your check-in to get personalized insights.</p>
    </div>

    <!-- Stats Grid -->
    <div class="stats-row mb-6">
      <div class="stat-card" onclick="location.href='checkin.html'" style="cursor:pointer">
        <div class="stat-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
        </div>
        <div class="stat-value" id="moodValue">—</div>
        <div class="stat-label">Mood</div>
      </div>
      <div class="stat-card" onclick="location.href='checkin.html'" style="cursor:pointer">
        <div class="stat-icon" style="background:var(--info-light);color:var(--info);">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/></svg>
        </div>
        <div class="stat-value" id="sleepValue">—</div>
        <div class="stat-label">Sleep</div>
      </div>
      <div class="stat-card" onclick="location.href='habits.html'" style="cursor:pointer">
        <div class="stat-icon" style="background:var(--warning-light);color:var(--warning);">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>
        </div>
        <div class="stat-value" id="streakValue">0</div>
        <div class="stat-label">Day Streak</div>
      </div>
      <div class="stat-card" onclick="location.href='focus.html'" style="cursor:pointer">
        <div class="stat-icon" style="background:var(--success-light);color:var(--success);">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        </div>
        <div class="stat-value"><span id="todayFocus">0</span><span class="text-sm text-muted">m</span></div>
        <div class="stat-label">Focus Today</div>
      </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="grid-2 mb-6">
      <!-- Today's Tasks -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Today's Tasks</h3>
          <a href="todo.html" class="btn btn-sm btn-ghost">View all</a>
        </div>
        <div id="todayTasks">
          <div class="empty-state">
            <div class="empty-state-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
            </div>
            <div class="empty-state-title">No tasks for today</div>
            <p class="empty-state-text">Add tasks to stay organized</p>
          </div>
        </div>
      </div>

      <!-- Today's Habits -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Today's Habits</h3>
          <a href="habits.html" class="btn btn-sm btn-ghost">View all</a>
        </div>
        <div id="todayHabits">
          <div class="empty-state">
            <div class="empty-state-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </div>
            <div class="empty-state-title">No habits yet</div>
            <p class="empty-state-text">Build consistency with habits</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
      <h3 class="card-title mb-4">Quick Actions</h3>
      <div class="quick-actions">
        <a href="checkin.html" class="quick-action">
          <div class="quick-action-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/></svg>
          </div>
          <span class="quick-action-label">Check-in</span>
        </a>
        <a href="focus.html" class="quick-action">
          <div class="quick-action-icon" style="background:var(--success-light);color:var(--success);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          </div>
          <span class="quick-action-label">Focus</span>
        </a>
        <a href="journal.html" class="quick-action">
          <div class="quick-action-icon" style="background:var(--warning-light);color:var(--warning);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          </div>
          <span class="quick-action-label">Journal</span>
        </a>
        <a href="analytics.html" class="quick-action">
          <div class="quick-action-icon" style="background:var(--info-light);color:var(--info);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
          </div>
          <span class="quick-action-label">Analytics</span>
        </a>
      </div>
    </div>
  </main>

  <div class="toast-container" id="toastContainer"></div>

  <script type="module">
    import { auth, db, onAuthStateChanged, signOut, doc, getDoc, collection, getDocs, query, where, orderBy, limit, getLocalDateString } from './js/config/firebase.js';
    
    let currentUser = null;
    const today = getLocalDateString();
    
    // Theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon();
    
    function updateThemeIcon() {
      const icon = document.getElementById('themeIcon');
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      icon.innerHTML = isDark 
        ? '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>'
        : '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
    }
    
    // Auth check
    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = 'index.html'; return; }
      currentUser = user;
      await loadDashboard();
    });
    
    async function loadDashboard() {
      // Date
      document.getElementById('todayDate').textContent = new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
      
      // Greeting
      const hour = new Date().getHours();
      let greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
      
      // Load data
      await Promise.all([loadUserProfile(greeting), loadCheckinData(), loadTodayTasks(), loadTodayHabits(), loadFocusTime()]);
    }
    
    async function loadUserProfile(greeting) {
      try {
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        const name = currentUser.displayName || 'there';
        document.getElementById('greeting').textContent = `${greeting}, ${name.split(' ')[0]}`;
        document.getElementById('navUserName').textContent = name;
        document.getElementById('navUserEmail').textContent = currentUser.email;
        document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
        
        if (userDoc.exists()) {
          const data = userDoc.data();
          document.getElementById('streakValue').textContent = data.stats?.currentStreak || 0;
        }
      } catch(e) { console.error(e); }
    }
    
    async function loadCheckinData() {
      try {
        const docRef = doc(db, 'users', currentUser.uid, 'checkins', today);
        const snap = await getDoc(docRef);
        if (snap.exists()) {
          const data = snap.data();
          document.getElementById('moodValue').textContent = data.mood || '—';
          document.getElementById('sleepValue').textContent = data.sleep || '—';
          
          // Update insight
          if (data.stress >= 7) {
            document.getElementById('insightText').textContent = "Your stress levels are elevated. Consider a short break or breathing exercise.";
          } else if (data.sleep === 'Poor') {
            document.getElementById('insightText').textContent = "Sleep quality affects focus. Try to rest earlier tonight.";
          } else if (data.mood === 'Happy' || data.mood === 'Calm') {
            document.getElementById('insightText').textContent = "You're in a great state today! Perfect time to tackle important tasks.";
          } else {
            document.getElementById('insightText').textContent = "Track your habits and focus to build a productive day.";
          }
        }
      } catch(e) { console.error(e); }
    }
    
    async function loadTodayTasks() {
      try {
        const q = query(collection(db, 'users', currentUser.uid, 'tasks'), where('date', '==', today));
        const snap = await getDocs(q);
        
        if (snap.empty) return;
        
        const tasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const container = document.getElementById('todayTasks');
        
        const pending = tasks.filter(t => !t.completed).slice(0, 4);
        if (pending.length === 0) {
          container.innerHTML = '<div class="text-center text-muted py-4">All tasks completed!</div>';
          return;
        }
        
        container.innerHTML = pending.map(t => {
          const priorityColor = t.priority === 'red' ? 'var(--error)' : t.priority === 'yellow' ? 'var(--warning)' : 'var(--primary)';
          return `<div class="list-item"><span style="width:8px;height:8px;background:${priorityColor};border-radius:50%;"></span><span class="flex-1">${t.text}</span></div>`;
        }).join('');
      } catch(e) { console.error(e); }
    }
    
    async function loadTodayHabits() {
      try {
        const snap = await getDocs(collection(db, 'users', currentUser.uid, 'habits'));
        if (snap.empty) return;
        
        const habits = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const container = document.getElementById('todayHabits');
        
        container.innerHTML = habits.slice(0, 4).map(h => {
          const done = h.completedDates?.includes(today);
          return `<div class="list-item">
            <span style="width:20px;height:20px;border-radius:50%;border:2px solid ${done ? 'var(--success)' : 'var(--border-color)'};background:${done ? 'var(--success)' : 'transparent'};display:flex;align-items:center;justify-content:center;color:white;font-size:12px;">${done ? '✓' : ''}</span>
            <span class="flex-1">${h.name}</span>
          </div>`;
        }).join('');
      } catch(e) { console.error(e); }
    }
    
    async function loadFocusTime() {
      try {
        const q = query(collection(db, 'users', currentUser.uid, 'focusSessions'), where('date', '==', today));
        const snap = await getDocs(q);
        
        let totalSeconds = 0;
        snap.forEach(d => { totalSeconds += d.data().duration || 0; });
        
        document.getElementById('todayFocus').textContent = Math.round(totalSeconds / 60);
      } catch(e) { console.error(e); }
    }
    
    // Theme toggle
    window.toggleTheme = function() {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeIcon();
    };
    
    // Sidebar toggle
    window.toggleSidebar = function() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('navOverlay').classList.toggle('show');
    };
    
    // Logout
    window.logout = async function() {
      await signOut(auth);
      window.location.href = 'index.html';
    };
  </script>
</body>
</html>
