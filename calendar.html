<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar | MindEase</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/app.css">
</head>
<body>
  <nav class="nav-sidebar" id="sidebar">
    <div class="nav-brand"><span class="nav-logo">ğŸŒ¿</span><span class="nav-title">MindEase</span></div>
    <div class="nav-menu">
      <a href="dashboard.html" class="nav-link"><span class="nav-icon">ğŸ </span><span>Dashboard</span></a>
      <a href="checkin.html" class="nav-link"><span class="nav-icon">ğŸ’­</span><span>Check-in</span></a>
      <a href="todo.html" class="nav-link"><span class="nav-icon">ğŸ“</span><span>Tasks</span></a>
      <a href="habits.html" class="nav-link"><span class="nav-icon">âœ…</span><span>Habits</span></a>
      <a href="focus.html" class="nav-link"><span class="nav-icon">â±ï¸</span><span>Focus</span></a>
      <a href="journal.html" class="nav-link"><span class="nav-icon">ğŸ“”</span><span>Journal</span></a>
      <a href="calendar.html" class="nav-link active"><span class="nav-icon">ğŸ“…</span><span>Calendar</span></a>
      <a href="analytics.html" class="nav-link"><span class="nav-icon">ğŸ“Š</span><span>Analytics</span></a>
      <a href="profile.html" class="nav-link"><span class="nav-icon">ğŸ‘¤</span><span>Profile</span></a>
    </div>
    <div class="nav-footer"><button class="btn btn-ghost w-full" onclick="logout()"><span>ğŸšª</span> Sign Out</button></div>
  </nav>

  <header class="mobile-header">
    <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
    <span class="mobile-title">Calendar</span>
    <button class="btn-icon btn-ghost" onclick="toggleTheme()">ğŸŒ™</button>
  </header>

  <main class="main-content">
    <div class="page-header">
      <h1>ğŸ“… Calendar</h1>
      <p class="text-muted">View your tasks and activities</p>
    </div>

    <div class="calendar-layout">
      <!-- Calendar -->
      <section class="glass calendar-section">
        <div class="calendar-header">
          <button class="btn btn-ghost" onclick="changeMonth(-1)">â†</button>
          <h3 id="monthYear"></h3>
          <button class="btn btn-ghost" onclick="changeMonth(1)">â†’</button>
        </div>
        <div class="calendar-weekdays">
          <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
        <div class="calendar-legend">
          <span><span class="legend-dot task"></span> Tasks</span>
          <span><span class="legend-dot checkin"></span> Check-in</span>
          <span><span class="legend-dot focus"></span> Focus</span>
        </div>
      </section>

      <!-- Selected Day Details -->
      <section class="glass details-section">
        <h3 id="selectedDate">Select a date</h3>
        <div id="dayDetails">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“…</div>
            <div class="empty-state-title">Click a date</div>
            <p class="text-sm text-muted">to see your activities</p>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="toast-container" id="toastContainer"></div>

  <style>
    .calendar-layout { display: grid; grid-template-columns: 1fr 300px; gap: var(--space-6); }
    @media (max-width: 900px) { .calendar-layout { grid-template-columns: 1fr; } }
    
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); }
    .calendar-header h3 { margin: 0; }
    
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; font-size: var(--text-sm); color: var(--text-muted); margin-bottom: var(--space-2); }
    
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: var(--space-1); }
    
    .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--space-1); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s ease; position: relative; font-size: var(--text-sm); }
    .calendar-day:hover { background: var(--glass-bg-hover); }
    .calendar-day.today { background: var(--gradient-primary); color: white; font-weight: 600; }
    .calendar-day.selected { outline: 2px solid var(--primary); outline-offset: 2px; }
    .calendar-day.other-month { opacity: 0.3; }
    
    .day-dots { display: flex; gap: 2px; margin-top: 2px; }
    .day-dot { width: 5px; height: 5px; border-radius: 50%; }
    .day-dot.task { background: var(--error); }
    .day-dot.checkin { background: var(--success); }
    .day-dot.focus { background: var(--primary); }
    
    .calendar-legend { display: flex; gap: var(--space-4); margin-top: var(--space-4); padding-top: var(--space-3); border-top: 1px solid var(--glass-border); font-size: var(--text-sm); color: var(--text-muted); }
    .legend-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 4px; vertical-align: middle; }
    .legend-dot.task { background: var(--error); }
    .legend-dot.checkin { background: var(--success); }
    .legend-dot.focus { background: var(--primary); }
    
    .details-section { height: fit-content; position: sticky; top: var(--space-4); }
    
    .day-item { padding: var(--space-3); background: var(--glass-bg); border-radius: var(--radius-md); margin-bottom: var(--space-2); }
    .day-item-type { font-size: var(--text-xs); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-1); }
    .day-item-content { font-weight: 500; }
    .day-item.completed .day-item-content { text-decoration: line-through; opacity: 0.6; }
  </style>

  <script type="module">
    import { auth, db, onAuthStateChanged, signOut, collection, getDocs, getLocalDateString } from './js/config/firebase.js';
    
    let currentUser = null;
    let tasks = [];
    let checkins = [];
    let focusSessions = [];
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDate = null;
    const today = getLocalDateString();
    
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = 'index.html'; return; }
      currentUser = user;
      await loadData();
      renderCalendar();
    });
    
    async function loadData() {
      try {
        const [tasksSnap, checkinsSnap, focusSnap] = await Promise.all([
          getDocs(collection(db, 'users', currentUser.uid, 'tasks')),
          getDocs(collection(db, 'users', currentUser.uid, 'checkins')),
          getDocs(collection(db, 'users', currentUser.uid, 'focusSessions'))
        ]);
        
        tasks = tasksSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        checkins = checkinsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        focusSessions = focusSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) {
        console.error('Error loading data:', e);
      }
    }
    
    function renderCalendar() {
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      document.getElementById('monthYear').textContent = `${monthNames[currentMonth]} ${currentYear}`;
      
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
      
      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const dateStr = formatDate(currentYear, currentMonth - 1, day);
        grid.appendChild(createDayElement(day, dateStr, true));
      }
      
      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = formatDate(currentYear, currentMonth, day);
        grid.appendChild(createDayElement(day, dateStr, false));
      }
      
      // Next month days
      const totalCells = firstDay + daysInMonth;
      const remainingCells = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;
      for (let day = 1; day <= remainingCells; day++) {
        const dateStr = formatDate(currentYear, currentMonth + 1, day);
        grid.appendChild(createDayElement(day, dateStr, true));
      }
    }
    
    function formatDate(year, month, day) {
      const d = new Date(year, month, day);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }
    
    function createDayElement(day, dateStr, isOtherMonth) {
      const div = document.createElement('div');
      div.className = 'calendar-day';
      if (isOtherMonth) div.classList.add('other-month');
      if (dateStr === today) div.classList.add('today');
      if (dateStr === selectedDate) div.classList.add('selected');
      
      div.innerHTML = `<span>${day}</span>`;
      
      // Add dots for activities
      const hasTasks = tasks.some(t => t.date === dateStr);
      const hasCheckin = checkins.some(c => c.date === dateStr);
      const hasFocus = focusSessions.some(f => f.date === dateStr);
      
      if (hasTasks || hasCheckin || hasFocus) {
        let dots = '<div class="day-dots">';
        if (hasTasks) dots += '<span class="day-dot task"></span>';
        if (hasCheckin) dots += '<span class="day-dot checkin"></span>';
        if (hasFocus) dots += '<span class="day-dot focus"></span>';
        dots += '</div>';
        div.innerHTML += dots;
      }
      
      div.onclick = () => showDayDetails(dateStr);
      return div;
    }
    
    function showDayDetails(dateStr) {
      selectedDate = dateStr;
      renderCalendar();
      
      const date = new Date(dateStr + 'T00:00:00');
      document.getElementById('selectedDate').textContent = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      
      const container = document.getElementById('dayDetails');
      const dayTasks = tasks.filter(t => t.date === dateStr);
      const dayCheckin = checkins.find(c => c.date === dateStr);
      const dayFocus = focusSessions.filter(f => f.date === dateStr);
      
      if (!dayTasks.length && !dayCheckin && !dayFocus.length) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“­</div>
            <div class="empty-state-title">Nothing here</div>
            <p class="text-sm text-muted">No activities recorded for this day</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      // Tasks
      dayTasks.forEach(t => {
        const emoji = t.priority === 'red' ? 'ğŸ”´' : t.priority === 'yellow' ? 'ğŸŸ¡' : 'ğŸ”µ';
        html += `
          <div class="day-item ${t.completed ? 'completed' : ''}">
            <div class="day-item-type">ğŸ“ Task</div>
            <div class="day-item-content">${emoji} ${t.text}</div>
          </div>
        `;
      });
      
      // Check-in
      if (dayCheckin) {
        const moodEmoji = { Happy: 'ğŸ˜Š', Calm: 'ğŸ˜Œ', Neutral: 'ğŸ˜', Stressed: 'ğŸ˜–', Sad: 'ğŸ˜”', Anxious: 'ğŸ˜°' };
        html += `
          <div class="day-item">
            <div class="day-item-type">ğŸ’­ Check-in</div>
            <div class="day-item-content">${moodEmoji[dayCheckin.mood] || ''} ${dayCheckin.mood || 'Logged'}</div>
            ${dayCheckin.sleep ? `<div class="text-sm text-muted">Sleep: ${dayCheckin.sleep}</div>` : ''}
          </div>
        `;
      }
      
      // Focus sessions
      dayFocus.forEach(f => {
        const mins = Math.round((f.duration || 0) / 60);
        html += `
          <div class="day-item">
            <div class="day-item-type">â±ï¸ Focus</div>
            <div class="day-item-content">${mins} min ${f.type || 'session'}</div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    window.changeMonth = function(delta) {
      currentMonth += delta;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      renderCalendar();
    };
    
    function showToast(msg, type='info') {
      const t = document.createElement('div');
      t.className = `toast toast-${type}`;
      t.textContent = msg;
      document.getElementById('toastContainer').appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }
    
    window.toggleTheme = function() {
      const n = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', n);
      localStorage.setItem('theme', n);
    };
    window.logout = async function() { await signOut(auth); window.location.href = 'index.html'; };
    window.toggleSidebar = function() { document.getElementById('sidebar').classList.toggle('open'); };
  </script>
</body>
</html>
