<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check-in | MindEase</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/app.css">
</head>
<body>
  <nav class="nav-sidebar" id="sidebar">
    <div class="nav-brand">
      <div class="nav-logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg></div>
      <span class="nav-title">MindEase</span>
    </div>
    <div class="nav-menu">
      <div class="nav-section">
        <div class="nav-section-title">Main</div>
        <a href="dashboard.html" class="nav-link"><span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></span><span>Dashboard</span></a>
        <a href="checkin.html" class="nav-link active"><span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></span><span>Check-in</span></a>
        <a href="todo.html" class="nav-link"><span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></span><span>Tasks</span></a>
        <a href="habits.html" class="nav-link"><span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span><span>Habits</span></a>
        <a href="focus.html" class="nav-link"><span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span><span>Focus</span></a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Wellness</div>
        <a href="journal.html" class="nav-link"><span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></span><span>Journal</span></a>
        <a href="calendar.html" class="nav-link"><span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span><span>Calendar</span></a>
        <a href="analytics.html" class="nav-link"><span class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg></span><span>Analytics</span></a>
      </div>
    </div>
    <div class="nav-footer"><a href="profile.html" class="nav-user"><div class="nav-avatar" id="userAvatar">U</div><div class="nav-user-info"><div class="nav-user-name" id="navUserName">User</div><div class="nav-user-email" id="navUserEmail">email</div></div></a></div>
  </nav>
  <div class="nav-overlay" id="navOverlay" onclick="toggleSidebar()"></div>

  <header class="mobile-header">
    <button class="menu-toggle" onclick="toggleSidebar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
    <span class="mobile-title">Check-in</span>
    <button class="theme-toggle" onclick="toggleTheme()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button>
  </header>

  <main class="main-content">
    <div class="page-header">
      <h1>Daily Check-in</h1>
      <p class="text-muted">Take a moment to reflect on how you're feeling</p>
    </div>

    <!-- Already Checked In Today -->
    <section class="card mb-6" id="alreadyCheckedIn" style="display: none;">
      <div class="checkin-complete">
        <div class="checkin-complete-icon"><svg viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" style="width:48px;height:48px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
        <h3>You've already checked in today!</h3>
        <p class="text-muted">Come back tomorrow to log your next check-in</p>
        <a href="analytics.html" class="btn">View Your Insights â†’</a>
      </div>
    </section>

    <form id="checkinForm" class="checkin-form">
      <!-- Mood -->
      <section class="card mb-6">
        <h3 class="card-title">How are you feeling?</h3>
        <div class="mood-grid">
          <button type="button" class="mood-btn" data-mood="Happy"><span class="mood-icon" style="color:#22c55e"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></span><span class="mood-label">Happy</span></button>
          <button type="button" class="mood-btn" data-mood="Calm"><span class="mood-icon" style="color:#3b82f6"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="8" y1="15" x2="16" y2="15"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></span><span class="mood-label">Calm</span></button>
          <button type="button" class="mood-btn" data-mood="Neutral"><span class="mood-icon" style="color:#94a3b8"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="8" y1="15" x2="16" y2="15"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></span><span class="mood-label">Neutral</span></button>
          <button type="button" class="mood-btn" data-mood="Stressed"><span class="mood-icon" style="color:#f97316"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16 16s-1.5-2-4-2-4 2-4 2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></span><span class="mood-label">Stressed</span></button>
          <button type="button" class="mood-btn" data-mood="Sad"><span class="mood-icon" style="color:#6366f1"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16 16s-1.5-2-4-2-4 2-4 2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></span><span class="mood-label">Sad</span></button>
          <button type="button" class="mood-btn" data-mood="Anxious"><span class="mood-icon" style="color:#ef4444"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16 16s-1.5-2-4-2-4 2-4 2"/><path d="M9 9h.01M15 9h.01"/></svg></span><span class="mood-label">Anxious</span></button>
        </div>
      </section>

      <!-- Energy & Focus -->
      <section class="card mb-6">
        <h3 class="card-title">Energy & Focus</h3>
        <div class="slider-group">
          <label>Energy Level</label>
          <div class="slider-row">
            <span class="slider-label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="9" x2="12" y2="2"/></svg></span>
            <input type="range" id="energy" min="1" max="10" value="5">
            <span class="slider-label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></span>
            <span class="slider-value" id="energyValue">5</span>
          </div>
        </div>
        <div class="slider-group">
          <label>Focus Level</label>
          <div class="slider-row">
            <span class="slider-label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><circle cx="12" cy="12" r="10" opacity="0.3"/></svg></span>
            <input type="range" id="focus" min="1" max="10" value="5">
            <span class="slider-label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></span>
            <span class="slider-value" id="focusValue">5</span>
          </div>
        </div>
        <div class="slider-group">
          <label>Stress Level</label>
          <div class="slider-row">
            <span class="slider-label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/></svg></span>
            <input type="range" id="stress" min="1" max="10" value="5">
            <span class="slider-label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><circle cx="12" cy="12" r="10"/><path d="M16 16s-1.5-2-4-2-4 2-4 2"/></svg></span>
            <span class="slider-value" id="stressValue">5</span>
          </div>
        </div>
      </section>

      <!-- Sleep -->
      <section class="card mb-6">
        <h3 class="card-title">How did you sleep?</h3>
        <div class="sleep-options">
          <button type="button" class="sleep-btn" data-sleep="Good"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;margin-right:8px;"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg> Good</button>
          <button type="button" class="sleep-btn" data-sleep="Okay"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;margin-right:8px;"><circle cx="12" cy="12" r="10"/><line x1="8" y1="15" x2="16" y2="15"/></svg> Okay</button>
          <button type="button" class="sleep-btn" data-sleep="Poor"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;margin-right:8px;"><circle cx="12" cy="12" r="10"/><path d="M16 16s-1.5-2-4-2-4 2-4 2"/></svg> Poor</button>
        </div>
      </section>

      <!-- Period Tracking (Optional) -->
      <section class="card mb-6">
        <h3 class="card-title">Period Tracking <span class="text-muted text-sm">(optional)</span></h3>
        <select id="period">
          <option value="">Not tracking today</option>
          <option value="Menstrual">Menstrual</option>
          <option value="PMS">PMS symptoms</option>
          <option value="Ovulation">Ovulation</option>
        </select>
      </section>

      <!-- Journal -->
      <section class="card mb-6">
        <h3 class="card-title">Anything on your mind? <span class="text-muted text-sm">(optional)</span></h3>
        <textarea id="journal" rows="4" placeholder="Write anything you want to remember about today..."></textarea>
      </section>

      <button type="submit" class="btn btn-lg w-full">Save Check-in</button>
    </form>
  </main>

  <div class="toast-container" id="toastContainer"></div>

  <style>
    .checkin-form { max-width: 600px; }
    .checkin-complete { text-align: center; padding: var(--space-6); }
    .checkin-complete-icon { margin-bottom: var(--space-4); }
    
    .mood-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-3); margin-top: var(--space-4); }
    .mood-btn { display: flex; flex-direction: column; align-items: center; padding: var(--space-4); background: var(--bg-elevated); border: 2px solid var(--border-color); border-radius: var(--radius-lg); cursor: pointer; transition: all 0.2s ease; }
    .mood-btn:hover { border-color: var(--primary); transform: translateY(-2px); }
    .mood-btn.active { background: var(--gradient-primary); border-color: transparent; color: white; }
    .mood-btn.active .mood-icon { color: white !important; }
    .mood-icon { margin-bottom: var(--space-2); }
    .mood-icon svg { width: 32px; height: 32px; }
    .mood-label { font-size: var(--text-sm); font-weight: 500; }
    
    .slider-group { margin-bottom: var(--space-4); }
    .slider-group:last-child { margin-bottom: 0; }
    .slider-group label { display: block; margin-bottom: var(--space-2); font-weight: 500; }
    .slider-row { display: flex; align-items: center; gap: var(--space-3); }
    .slider-row input[type="range"] { flex: 1; }
    .slider-label { color: var(--text-muted); }
    .slider-value { min-width: 30px; text-align: center; font-weight: 600; color: var(--primary); }
    
    .sleep-options { display: flex; gap: var(--space-3); flex-wrap: wrap; margin-top: var(--space-4); }
    .sleep-btn { flex: 1; min-width: 100px; padding: var(--space-3); background: var(--bg-elevated); border: 2px solid var(--border-color); border-radius: var(--radius-lg); cursor: pointer; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .sleep-btn:hover { border-color: var(--primary); }
    .sleep-btn.active { background: var(--gradient-primary); border-color: transparent; color: white; }
    
    @media (max-width: 480px) {
      .mood-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>

  <script type="module">
    import { auth, db, onAuthStateChanged, signOut, doc, setDoc, getDoc, getLocalDateString, Timestamp } from './js/config/firebase.js';
    
    let currentUser = null;
    let selectedMood = null;
    let selectedSleep = null;
    const today = getLocalDateString();
    
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    
    async function checkTodayCheckin() {
      try {
        const docRef = doc(db, 'users', currentUser.uid, 'checkins', today);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          document.getElementById('checkinForm').style.display = 'none';
          document.getElementById('alreadyCheckedIn').style.display = 'block';
        }
      } catch (e) {
        console.error('Error checking today checkin:', e);
      }
    }
    
    // Mood buttons
    document.querySelectorAll('.mood-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedMood = btn.dataset.mood;
      };
    });
    
    // Sleep buttons
    document.querySelectorAll('.sleep-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.sleep-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedSleep = btn.dataset.sleep;
      };
    });
    
    // Slider values
    ['energy', 'focus', 'stress'].forEach(id => {
      const slider = document.getElementById(id);
      const valueEl = document.getElementById(id + 'Value');
      slider.oninput = () => { valueEl.textContent = slider.value; };
    });
    
    // Form submit
    document.getElementById('checkinForm').onsubmit = async (e) => {
      e.preventDefault();
      
      if (!selectedMood) {
        showToast('Please select a mood', 'error');
        return;
      }
      
      if (!selectedSleep) {
        showToast('Please select sleep quality', 'error');
        return;
      }
      
      const data = {
        date: today,
        mood: selectedMood,
        energy: Number(document.getElementById('energy').value),
        focus: Number(document.getElementById('focus').value),
        stress: Number(document.getElementById('stress').value),
        sleep: selectedSleep,
        period: document.getElementById('period').value || null,
        journal: document.getElementById('journal').value.trim() || null,
        createdAt: Timestamp.now()
      };
      
      try {
        await setDoc(doc(db, 'users', currentUser.uid, 'checkins', today), data);
        showToast('Check-in saved! ðŸŒ±', 'success');
        setTimeout(() => { window.location.href = 'dashboard.html'; }, 1000);
      } catch (e) {
        console.error('Error saving checkin:', e);
        showToast('Failed to save check-in', 'error');
      }
    };
    
    function showToast(msg, type='info') {
      const t = document.createElement('div');
      t.className = `toast toast-${type}`;
      t.textContent = msg;
      document.getElementById('toastContainer').appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }
    
    window.toggleTheme = function() {
      const n = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', n);
      localStorage.setItem('theme', n);
    };
    window.logout = async function() { await signOut(auth); window.location.href = 'index.html'; };
    window.toggleSidebar = function() { 
      document.getElementById('sidebar').classList.toggle('open'); 
      document.getElementById('navOverlay').classList.toggle('show');
    };
    
    // Update user info in nav
    function updateNavUser() {
      if (currentUser) {
        const name = currentUser.displayName || 'User';
        document.getElementById('navUserName').textContent = name;
        document.getElementById('navUserEmail').textContent = currentUser.email;
        document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
      }
    }
    
    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = 'index.html'; return; }
      currentUser = user;
      updateNavUser();
      await checkTodayCheckin();
    });
  </script>
</body>
</html>
